<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Z晓L's Blog, welcome to my nerverland">


        <title>HADOOP报错namespaceIDs不一致 // Z晓L's Blog // welcome to my nerverland</title>

    <link href="/favicon.ico" rel="icon">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/theme/css/pure.css">
    <link rel="stylesheet" href="/theme/css/solarized.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
<div class="pure-g-r" id="layout">
    <div class="sidebar sidebar-article pure-u">
        <header class="header-article">
            <hgroup>
                <a href="/author/nexrol.html" title="See posts by nexrol">
                </a>
                <h2 class="article-info">nexrol</h2>
                <!--small class="about-author"></small-->
                <p class="social">
                        <a href="#">
                            <i class="fa fa-github fa-lg"></i>
                        </a>
                        <a href="#">
                            <i class="fa fa-weibo fa-lg"></i>
                        </a>
                        <a href="#">
                            <i class="fa fa-envelope fa-lg"></i>
                        </a>
                        <a href="#">
                            <i class="fa fa-rss-square fa-lg"></i>
                        </a>
                </p>
                <h5>Published</h5>
                <p>五 02 十一月 2012</p>
                <a href="/">&larr;Home</a>
            </hgroup>
        </header>
    </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>HADOOP报错namespaceIDs不一致</h1>
                        <p class="post-meta">
                        Category: <a class="post-category" href="/category/hadoop.html">hadoop</a> Tags:                                 <a class="post-category" href="/tag/hadoop.html">hadoop</a>
                        </p>
                </header>
            </section>
            <p>DATANODE日志如下</p>
<div class="highlight"><pre><span class="nt">2012-07-21</span> <span class="nt">10</span><span class="nd">:12:11</span><span class="o">,</span><span class="nt">987</span> <span class="nt">ERROR</span> <span class="nt">org</span><span class="nc">.apache.hadoop.hdfs.server.datanode.DataNode</span><span class="o">:</span> <span class="nt">java</span><span class="nc">.io.IOException</span><span class="o">:</span> <span class="nt">Incompatible</span> <span class="nt">namespaceIDs</span> <span class="nt">in</span> <span class="o">/</span><span class="nt">home</span><span class="o">/</span><span class="nt">admin</span><span class="o">/</span><span class="nt">joe</span><span class="nc">.wangh</span><span class="o">/</span><span class="nt">hadoop</span><span class="o">/</span><span class="nt">data</span><span class="o">/</span><span class="nt">dfs</span><span class="nc">.data.dir</span><span class="o">:</span> <span class="nt">namenode</span> <span class="nt">namespaceID</span> <span class="o">=</span> <span class="nt">898136669</span><span class="o">;</span> <span class="nt">datanode</span> <span class="nt">namespaceID</span> <span class="o">=</span> <span class="nt">2127444065</span>
<span class="nt">at</span> <span class="nt">org</span><span class="nc">.apache.hadoop.hdfs.server.datanode.DataStorage.doTransition</span><span class="o">(</span><span class="nt">DataStorage</span><span class="nc">.java</span><span class="nd">:233</span><span class="o">)</span>
<span class="nt">at</span> <span class="nt">org</span><span class="nc">.apache.hadoop.hdfs.server.datanode.DataStorage.recoverTransitionRead</span><span class="o">(</span><span class="nt">DataStorage</span><span class="nc">.java</span><span class="nd">:148</span><span class="o">)</span>
<span class="nt">at</span> <span class="nt">org</span><span class="nc">.apache.hadoop.hdfs.server.datanode.DataNode.startDataNode</span><span class="o">(</span><span class="nt">DataNode</span><span class="nc">.java</span><span class="nd">:288</span><span class="o">)</span>
<span class="nt">at</span> <span class="nt">org</span><span class="nc">.apache.hadoop.hdfs.server.datanode.DataNode</span><span class="o">.(</span><span class="nt">DataNode</span><span class="nc">.java</span><span class="nd">:206</span><span class="o">)</span>
<span class="nt">at</span> <span class="nt">org</span><span class="nc">.apache.hadoop.hdfs.server.datanode.DataNode.makeInstance</span><span class="o">(</span><span class="nt">DataNode</span><span class="nc">.java</span><span class="nd">:1239</span><span class="o">)</span>
<span class="nt">at</span> <span class="nt">org</span><span class="nc">.apache.hadoop.hdfs.server.datanode.DataNode.instantiateDataNode</span><span class="o">(</span><span class="nt">DataNode</span><span class="nc">.java</span><span class="nd">:1194</span><span class="o">)</span>
<span class="nt">at</span> <span class="nt">org</span><span class="nc">.apache.hadoop.hdfs.server.datanode.DataNode.createDataNode</span><span class="o">(</span><span class="nt">DataNode</span><span class="nc">.java</span><span class="nd">:1202</span><span class="o">)</span>
<span class="nt">at</span> <span class="nt">org</span><span class="nc">.apache.hadoop.hdfs.server.datanode.DataNode.main</span><span class="o">(</span><span class="nt">DataNode</span><span class="nc">.java</span><span class="nd">:1324</span><span class="o">)</span>
<span class="err">……</span>
</pre></div>


<p>错误提示namespaceIDs不一致。</p>
<p>下面给出两种解决办法，我使用的是第二种。</p>
<p>1.</p>
<div class="highlight"><pre><span class="nt">Start</span> <span class="nt">from</span> <span class="nt">scratch</span>
<span class="nt">I</span> <span class="nt">can</span> <span class="nt">testify</span> <span class="nt">that</span> <span class="nt">the</span> <span class="nt">following</span> <span class="nt">steps</span> <span class="nt">solve</span> <span class="nt">this</span> <span class="nt">error</span><span class="o">,</span> <span class="nt">but</span> <span class="nt">the</span> <span class="nt">side</span> <span class="nt">effects</span> <span class="nt">won</span><span class="err">’</span><span class="nt">t</span> <span class="nt">make</span> <span class="nt">you</span> <span class="nt">happy</span> <span class="o">(</span><span class="nt">me</span> <span class="nt">neither</span><span class="o">).</span> <span class="nt">The</span> <span class="nt">crude</span> <span class="nt">workaround</span> <span class="nt">I</span> <span class="nt">have</span> <span class="nt">found</span> <span class="nt">is</span> <span class="nt">to</span><span class="o">:</span>
<span class="nt">1</span><span class="o">.</span> <span class="nt">stop</span> <span class="nt">the</span> <span class="nt">cluster</span>
<span class="nt">2</span><span class="o">.</span> <span class="nt">delete</span> <span class="nt">the</span> <span class="nt">data</span> <span class="nt">directory</span> <span class="nt">on</span> <span class="nt">the</span> <span class="nt">problematic</span> <span class="nt">datanode</span><span class="o">:</span> <span class="nt">the</span> <span class="nt">directory</span> <span class="nt">is</span> <span class="nt">specified</span> <span class="nt">by</span> <span class="nt">dfs</span><span class="nc">.data.dir</span> <span class="nt">in</span> <span class="nt">conf</span><span class="o">/</span><span class="nt">hdfs-site</span><span class="nc">.xml</span><span class="o">;</span> <span class="nt">if</span> <span class="nt">you</span> <span class="nt">followed</span> <span class="nt">this</span> <span class="nt">tutorial</span><span class="o">,</span> <span class="nt">the</span> <span class="nt">relevant</span> <span class="nt">directory</span> <span class="nt">is</span> <span class="o">/</span><span class="nt">usr</span><span class="o">/</span><span class="nt">local</span><span class="o">/</span><span class="nt">hadoop-datastore</span><span class="o">/</span><span class="nt">hadoop-hadoop</span><span class="o">/</span><span class="nt">dfs</span><span class="o">/</span><span class="nt">data</span>
<span class="nt">3</span><span class="o">.</span> <span class="nt">reformat</span> <span class="nt">the</span> <span class="nt">namenode</span> <span class="o">(</span><span class="nt">NOTE</span><span class="o">:</span> <span class="nt">all</span> <span class="nt">HDFS</span> <span class="nt">data</span> <span class="nt">is</span> <span class="nt">lost</span> <span class="nt">during</span> <span class="nt">this</span> <span class="nt">process</span><span class="o">!)</span>
<span class="nt">4</span><span class="o">.</span> <span class="nt">restart</span> <span class="nt">the</span> <span class="nt">cluster</span>
<span class="nt">When</span> <span class="nt">deleting</span> <span class="nt">all</span> <span class="nt">the</span> <span class="nt">HDFS</span> <span class="nt">data</span> <span class="nt">and</span> <span class="nt">starting</span> <span class="nt">from</span> <span class="nt">scratch</span> <span class="nt">does</span> <span class="nt">not</span> <span class="nt">sound</span> <span class="nt">like</span> <span class="nt">a</span> <span class="nt">good</span> <span class="nt">idea</span> <span class="o">(</span><span class="nt">it</span> <span class="nt">might</span> <span class="nt">be</span> <span class="nt">ok</span> <span class="nt">during</span> <span class="nt">the</span> <span class="nt">initial</span> <span class="nt">setup</span><span class="o">/</span><span class="nt">testing</span><span class="o">),</span> <span class="nt">you</span> <span class="nt">might</span> <span class="nt">give</span> <span class="nt">the</span> <span class="nt">second</span> <span class="nt">approach</span> <span class="nt">a</span> <span class="nt">try</span><span class="o">.</span>
</pre></div>


<p>2.</p>
<div class="highlight"><pre>Updating namespaceID of problematic datanodes
Big thanks to Jared Stehler for the following suggestion. I have not tested it myself yet, but feel free to try it out and send me your feedback. This workaround is “minimally invasive” as you only have to edit one file on the problematic datanodes:
1. stop the datanode
2. edit the value of namespaceID in /current/VERSION to match the value of the current namenode
3. restart the datanode
If you followed the instructions in my tutorials, the full path of the relevant file is /usr/local/hadoop-datastore/hadoop-hadoop/dfs/data/current/VERSION (background: dfs.data.dir is by default set to <span class="cp">${</span><span class="n">hadoop</span><span class="o">.</span><span class="n">tmp</span><span class="o">.</span><span class="n">dir</span><span class="cp">}</span>/dfs/data, and we set hadoop.tmp.dir to /usr/local/hadoop-datastore/hadoop-hadoop).
If you wonder how the contents of VERSION look like, here’s one of mine:
#contents of /current/VERSION
namespaceID=393514426
storageID=DS-1706792599-10.10.10.1-50010-1204306713481
cTime=1215607609074
storageType=DATA_NODE
layoutVersion=-13
</pre></div>


<p>原因:每次namenode format会重新创建一个namenodeId,而tmp/dfs/data下包含了上次format下的id,namenode format清空了namenode下的数据,但是没有晴空datanode下的数据,导致启动时失败,所要做的就是每次fotmat前,清空tmp一下 的所有目录.</p>
            <section id="copyright">
            <center>
                <div class="copyright">
                    版权声明：自由转载-非商用-非衍生-保持署名
                </div>
                <div class="donation">
                    <img src="/images/donation.png"/>
                    <br>
                    <strong> 如果你觉得我的文章或项目对你有所帮助, You can buy me a cup of coffee:) </strong>
                </div>
            </center>
            </section>
            <div class="hr"></div>
            <a href="#" class="go-top">Go Top</a>
<footer class="footer">
    <p>&copy; Z晓L's Blog &ndash;
        Built with <a href="https://github.com/PurePelicanTheme/pure">Pure Theme</a>
        for <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
</div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>
</body>
</html>